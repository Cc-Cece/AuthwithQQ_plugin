name: Dev Build and Release

on:
  push:
    branches: 
      - main
      - 'feature/**'
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Add Build Type Annotation
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "::notice title=Feature Branch Build::Building from feature branch: ${{ github.ref_name }}"
            echo "::warning::This is a feature branch build for testing purposes"
          else
            echo "::notice title=Main Branch Build::Building from main branch"
          fi

      # æ˜¾å¼æ‰§è¡Œ shadowJar ç¡®ä¿ç”Ÿæˆå…¨é‡åŒ…
      # ä½¿ç”¨ --continue å¿½ç•¥ Checkstyle ç­‰éè‡´å‘½é”™è¯¯
      - name: Build with ShadowJar
        run: ./gradlew shadowJar --continue

      - name: Find Release Asset
        id: find_asset
        run: |
          # 1. æ‰“å°æ„å»ºç›®å½•ï¼Œæ–¹ä¾¿åœ¨ Action æ—¥å¿—ä¸­æ’æŸ¥
          echo "Files in build/libs:"
          ls -R build/libs
          
          # 2. åŠ¨æ€å¯»æ‰¾ JARï¼šæ’é™¤ plain ç˜¦åŒ…ï¼Œè·å–ç¬¬ä¸€ä¸ªåŒ¹é…çš„ jar
          # ä½¿ç”¨ -maxdepth 1 é¿å…æŠ“å–åˆ°æŸäº›ç¼“å­˜ç›®å½•
          RELEASE_JAR=$(find build/libs -maxdepth 1 -name "*.jar" ! -name "*-plain.jar" -print -quit)
          
          if [ -z "$RELEASE_JAR" ]; then
            echo "::error::No valid JAR found. Ensure shadowJar task completed."
            exit 1
          fi
          
          # 3. è®¾ç½®è¾“å‡ºå˜é‡
          echo "PATH=$RELEASE_JAR" >> "$GITHUB_OUTPUT"
          echo "NAME=$(basename $RELEASE_JAR)" >> "$GITHUB_OUTPUT"
          echo "BRANCH_TYPE=${{ github.ref == 'refs/heads/main' && 'main' || 'feature' }}" >> "$GITHUB_OUTPUT"
          echo "BRANCH_NAME=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          echo "Found Asset: $RELEASE_JAR"

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ format('{0}-{1}-build-{2}', steps.find_asset.outputs.BRANCH_TYPE, steps.find_asset.outputs.BRANCH_NAME, github.run_number) }}
          path: ${{ steps.find_asset.outputs.PATH }}
          retention-days: ${{ steps.find_asset.outputs.BRANCH_TYPE == 'main' && 30 || 14 }}

      - name: Log Artifact Info
        run: |
          echo "::notice title=Artifact Uploaded::Artifact name: ${{ format('{0}-{1}-build-{2}', steps.find_asset.outputs.BRANCH_TYPE, steps.find_asset.outputs.BRANCH_NAME, github.run_number) }}"
          echo "::notice::Retention: ${{ steps.find_asset.outputs.BRANCH_TYPE == 'main' && 30 || 14 }} days"

      - name: Update Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.find_asset.outputs.PATH }}
          tag_name: ${{ github.ref == 'refs/heads/main' && 'dev' || format('feature/{0}', github.ref_name) }}
          name: ${{ github.ref == 'refs/heads/main' && format('Latest Dev Build (#{0})', github.run_number) || format('Feature Build: {0} (#{1})', github.ref_name, github.run_number) }}
          body: |
            ${{ github.ref != 'refs/heads/main' && format('> [!WARNING]\n> è¿™æ˜¯ Feature åˆ†æ”¯ `{0}` çš„æµ‹è¯•æ„å»ºï¼Œä»…ä¾›æµ‹è¯•ä½¿ç”¨ã€‚\n\n', github.ref_name) || '' }}
            ## ğŸ›  æœ€æ–°æ„å»ºè¯¦æƒ…
            - **åˆ†æ”¯**: `${{ github.ref_name }}`
            - **æ„å»ºç±»å‹**: ${{ github.ref == 'refs/heads/main' && 'æ­£å¼æ„å»º' || 'Feature æµ‹è¯•æ„å»º' }}
            - **é¡¹ç›®åç§°**: `${{ steps.find_asset.outputs.NAME }}`
            - **æäº¤ä¿¡æ¯**: `${{ github.event.head_commit.message }}`
            - **æäº¤å“ˆå¸Œ**: `${{ github.sha }}`
            - **æ„å»ºç¼–å·**: `${{ github.run_number }}`
            
            ${{ github.ref == 'refs/heads/main' && '> [!TIP]\n> å¦‚æœæ„å»ºé€šè¿‡ä½†æœ‰é»„è‰²è­¦å‘Šï¼Œè¯´æ˜ä»£ç è§„èŒƒï¼ˆCheckstyle/SpotBugsï¼‰æœªå®Œå…¨è¾¾æ ‡ã€‚' || '> [!NOTE]\n> æ­¤æ„å»ºæ¥è‡ª Feature åˆ†æ”¯ï¼Œå¯èƒ½åŒ…å«æœªå®Œæˆçš„ç‰¹æ€§ï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚' }}
            
            ## ğŸ“¦ å†å²æ„å»º
            > [!INFO]
            > å†å²æ„å»ºä¿å­˜åœ¨ GitHub Actions Artifacts ä¸­ã€‚
            > 
            > **å¦‚ä½•ä¸‹è½½å†å²æ„å»ºï¼š**
            > 1. è®¿é—® [Actions é¡µé¢](https://github.com/${{ github.repository }}/actions)
            > 2. æ‰¾åˆ°å¯¹åº”çš„æ„å»ºè¿è¡Œè®°å½•
            > 3. åœ¨ Artifacts éƒ¨åˆ†ä¸‹è½½æ„å»ºäº§ç‰©
            > 
            > **Artifact å‘½åè§„åˆ™ï¼š**
            > - Main åˆ†æ”¯: `main-dev-build-{æ„å»ºå·}`
            > - Feature åˆ†æ”¯: `feature-{åˆ†æ”¯å}-build-{æ„å»ºå·}`
          prerelease: ${{ github.ref != 'refs/heads/main' }}
          make_latest: ${{ github.ref == 'refs/heads/main' }}
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}