name: Dev Build and Release

on:
  push:
    branches: 
      - main
      - 'feature/**'
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Add Build Type Annotation
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "::notice title=Feature Branch Build::Building from feature branch: ${{ github.ref_name }}"
            echo "::warning::This is a feature branch build for testing purposes"
          else
            echo "::notice title=Main Branch Build::Building from main branch"
          fi

      # 显式执行 shadowJar 确保生成全量包
      # 使用 --continue 忽略 Checkstyle 等非致命错误
      - name: Build with ShadowJar
        run: ./gradlew shadowJar --continue

      - name: Find Release Asset
        id: find_asset
        run: |
          # 1. 打印构建目录，方便在 Action 日志中排查
          echo "Files in build/libs:"
          ls -R build/libs
          
          # 2. 动态寻找 JAR：排除 plain 瘦包，获取第一个匹配的 jar
          # 使用 -maxdepth 1 避免抓取到某些缓存目录
          RELEASE_JAR=$(find build/libs -maxdepth 1 -name "*.jar" ! -name "*-plain.jar" -print -quit)
          
          if [ -z "$RELEASE_JAR" ]; then
            echo "::error::No valid JAR found. Ensure shadowJar task completed."
            exit 1
          fi
          
          # 3. 处理分支名：将斜杠替换为连字符（artifact 名称不允许斜杠）
          BRANCH_NAME_SAFE=$(echo "${{ github.ref_name }}" | tr '/' '-')
          
          # 4. 设置输出变量
          echo "PATH=$RELEASE_JAR" >> "$GITHUB_OUTPUT"
          echo "NAME=$(basename $RELEASE_JAR)" >> "$GITHUB_OUTPUT"
          echo "BRANCH_TYPE=${{ github.ref == 'refs/heads/main' && 'main' || 'feature' }}" >> "$GITHUB_OUTPUT"
          echo "BRANCH_NAME=$BRANCH_NAME_SAFE" >> "$GITHUB_OUTPUT"
          echo "Found Asset: $RELEASE_JAR"

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ format('{0}-{1}-build-{2}', steps.find_asset.outputs.BRANCH_TYPE, steps.find_asset.outputs.BRANCH_NAME, github.run_number) }}
          path: ${{ steps.find_asset.outputs.PATH }}
          retention-days: ${{ steps.find_asset.outputs.BRANCH_TYPE == 'main' && 30 || 14 }}

      - name: Log Artifact Info
        run: |
          echo "::notice title=Artifact Uploaded::Artifact name: ${{ format('{0}-{1}-build-{2}', steps.find_asset.outputs.BRANCH_TYPE, steps.find_asset.outputs.BRANCH_NAME, github.run_number) }}"
          echo "::notice::Retention: ${{ steps.find_asset.outputs.BRANCH_TYPE == 'main' && 30 || 14 }} days"

      - name: Update Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.find_asset.outputs.PATH }}
          tag_name: ${{ github.ref == 'refs/heads/main' && 'dev' || format('feature/{0}', github.ref_name) }}
          name: "${{ github.ref == 'refs/heads/main' && format('Latest Dev Build (#{0})', github.run_number) || format('Feature Build: {0} (#{1})', github.ref_name, github.run_number) }}"
          body: |
            ## 最新构建信息
            - **分支**: `${{ github.ref_name }}`
            - **构建类型**: ${{ github.ref == 'refs/heads/main' && '正式构建' || 'Feature 构建' }}
            - **项目名称**: `${{ steps.find_asset.outputs.NAME }}`
            - **提交信息**: `${{ github.event.head_commit.message }}`
            - **提交哈希**: `${{ github.sha }}`
            - **构建编号**: `${{ github.run_number }}`
                        
            ## 历史构建
            > [!TIP]
            > 历史构建保存在 GitHub Actions Artifacts 中。
          prerelease: ${{ github.ref != 'refs/heads/main' }}
          make_latest: ${{ github.ref == 'refs/heads/main' }}
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}