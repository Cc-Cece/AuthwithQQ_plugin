name: Dev Build and Release

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Grant execute permission
        run: chmod +x gradlew

      # æ˜¾å¼æ‰§è¡Œ shadowJar ç¡®ä¿ç”Ÿæˆå…¨é‡åŒ…
      # ä½¿ç”¨ --continue å¿½ç•¥ Checkstyle ç­‰éè‡´å‘½é”™è¯¯
      - name: Build with ShadowJar
        run: ./gradlew shadowJar --continue

      - name: Find Release Asset
        id: find_asset
        run: |
          # 1. æ‰“å°æ„å»ºç›®å½•ï¼Œæ–¹ä¾¿åœ¨ Action æ—¥å¿—ä¸­æ’æŸ¥
          echo "Files in build/libs:"
          ls -R build/libs
          
          # 2. åŠ¨æ€å¯»æ‰¾ JARï¼šæ’é™¤ plain ç˜¦åŒ…ï¼Œè·å–ç¬¬ä¸€ä¸ªåŒ¹é…çš„ jar
          # ä½¿ç”¨ -maxdepth 1 é¿å…æŠ“å–åˆ°æŸäº›ç¼“å­˜ç›®å½•
          RELEASE_JAR=$(find build/libs -maxdepth 1 -name "*.jar" ! -name "*-plain.jar" -print -quit)
          
          if [ -z "$RELEASE_JAR" ]; then
            echo "::error::No valid JAR found. Ensure shadowJar task completed."
            exit 1
          fi
          
          # 3. è®¾ç½®è¾“å‡ºå˜é‡
          echo "PATH=$RELEASE_JAR" >> "$GITHUB_OUTPUT"
          echo "NAME=$(basename $RELEASE_JAR)" >> "$GITHUB_OUTPUT"
          echo "Found Asset: $RELEASE_JAR"

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dev-build-${{ github.run_number }}
          path: ${{ steps.find_asset.outputs.PATH }}
          retention-days: 14

      - name: Update Dev Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.find_asset.outputs.PATH }}
          tag_name: dev
          name: "Latest Dev Build (#${{ github.run_number }})"
          body: |
            ## ğŸ›  æ„å»ºè¯¦æƒ…
            - **é¡¹ç›®åç§°**: `${{ steps.find_asset.outputs.NAME }}`
            - **æäº¤ä¿¡æ¯**: `${{ github.event.head_commit.message }}`
            - **æäº¤å“ˆå¸Œ**: `${{ github.sha }}`
            - **æ„å»ºç¼–å·**: `${{ github.run_number }}`
            
            > [!TIP]
            > å¦‚æœæ„å»ºé€šè¿‡ä½†æœ‰é»„è‰²è­¦å‘Šï¼Œè¯´æ˜ä»£ç è§„èŒƒï¼ˆCheckstyle/SpotBugsï¼‰æœªå®Œå…¨è¾¾æ ‡ã€‚
          prerelease: true
          make_latest: false
          # å¼ºåˆ¶è¦†ç›–æ—§çš„ dev æ ‡ç­¾å…³è”çš„ Release
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}