name: Dev Build and Release

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions: # æ˜¾å¼å£°æ˜æƒé™ï¼Œç¡®ä¿ Release å’Œ Artifact å¯ç”¨
      contents: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle' # è‡ªåŠ¨ç¼“å­˜ä¾èµ–ï¼Œæ˜¾è‘—æå‡ç¬¬äºŒæ¬¡æ„å»ºé€Ÿåº¦

      - name: Grant execute permission
        run: chmod +x gradlew

      # æ ¸å¿ƒæ„å»ºæ­¥éª¤ï¼šä½¿ç”¨ --continue ç¡®ä¿å³ä½¿ Checkstyle æŠ¥é”™ä¹Ÿä¼šå°è¯•ç”Ÿæˆ JAR
      - name: Build with Gradle
        run: ./gradlew build --continue

      - name: Find Release Asset
        id: find_asset
        run: |
          # å¯»æ‰¾ shadowJar ç”Ÿæˆçš„åŒ…ï¼Œæ’é™¤ plain ç˜¦åŒ…
          RELEASE_JAR=$(find build/libs -name 'AuthWithQq-*.jar' ! -name '*-plain.jar' -print -quit)
          if [ -z "$RELEASE_JAR" ]; then
            echo "::error::Build failed to produce a valid JAR."
            exit 1
          fi
          echo "PATH=$RELEASE_JAR" >> "$GITHUB_OUTPUT"
          echo "NAME=$(basename $RELEASE_JAR)" >> "$GITHUB_OUTPUT"

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AuthWithQq-dev-build-${{ github.run_number }}
          path: ${{ steps.find_asset.outputs.PATH }}
          retention-days: 60

      - name: Update Dev Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.find_asset.outputs.PATH }}
          tag_name: dev
          name: "Latest Dev Build (#${{ github.run_number }})"
          body: |
            ## ğŸ›  æ„å»ºè¯¦æƒ…
            - **æäº¤ä¿¡æ¯**: `${{ github.event.head_commit.message }}`
            - **æäº¤å“ˆå¸Œ**: `${{ github.sha }}`
            - **æ„å»ºç¼–å·**: `${{ github.run_number }}`
            
            > [!TIP]
            > æ‰€æœ‰å†å²æ„å»ºè¯·åœ¨ Actions é¡µé¢ä¸‹è½½ Artifactsã€‚
            > å¦‚æœæ„å»ºæ˜¾ç¤ºé»„è‰²è­¦å‘Šï¼Œè¯´æ˜ Checkstyle è§„èŒƒæœªè¾¾æ ‡ï¼Œä½†ä¸å½±å“ JAR åŠŸèƒ½ã€‚
          prerelease: true
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}