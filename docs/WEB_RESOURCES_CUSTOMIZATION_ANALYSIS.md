# 网页静态资源外部化 - 实现分析与代价比较

## 一、当前实现

- **来源**：JAR 内嵌资源 `src/main/resources/web/*`
- **服务方式**：`StaticFileHandler` 通过 `plugin.getResource("web/xxx.html")` 直接从 JAR 读取
- **特点**：不可自定义，更新插件即更新页面

---

## 二、目标

插件启用时将默认网页资源复制到 `plugins/AuthWithQq/web/`，并优先从该目录读取，使服主可修改样式和结构。

---

## 三、实现方案对比

### 方案 A：首次复制 + 优先读文件 + JAR 回退（推荐）

| 项目 | 说明 |
|------|------|
| **启用时** | 若 `web/` 不存在，从 JAR 复制全部默认文件；若已存在则不覆盖 |
| **请求时** | 1) 先读 `plugins/AuthWithQq/web/xxx` 2) 不存在则读 JAR 内资源 |
| **自定义** | 修改插件目录下文件即可生效，无需重载 |
| **更新** | 新增文件自动由 JAR 提供；已修改的旧文件保持服主版本 |

**优点**：实现简单、兼容更新、不破坏已有自定义  
**缺点**：需要维护 JAR 内资源列表（或用递归遍历实现）

---

### 方案 B：每次启用都复制（不推荐）

- 每次启用覆盖 `web/` 下所有文件
- **缺点**：会覆盖服主所有自定义，不适合本需求

---

### 方案 C：双目录（web_default + web）

- `web_default/`：默认资源，每次启用可覆盖
- `web/`：服主自定义，优先使用
- 请求时：`web/` → `web_default/` → JAR

**优点**：服主可对比默认、自行合并  
**缺点**：目录结构更复杂，维护成本高

---

## 四、推荐方案 A 的实现要点

### 1. 资源复制（saveDefaultWebResources）

```java
// 类似 saveDefaultConfig / saveDefaultLang
// 仅当 web 目录不存在时，从 JAR 复制所有 web/* 文件
// 使用 saveResource("web/xxx.html", false) 逐文件复制
```

**资源列表维护方式**：

- **方式 1（简单）**：代码中硬编码文件名列表（约 25 个文件）
- **方式 2（灵活）**：用 `JarFile` 遍历 JAR 内 `web/` 下所有条目

### 2. 静态文件服务逻辑（StaticFileHandler）

```text
请求 /web/auth.html
  → 检查 File(dataFolder, "web/auth.html") 是否存在
  → 存在：从文件读取并返回
  → 不存在：plugin.getResource("web/auth.html") 作为回退
```

### 3. 需改动的代码位置

| 文件 | 改动 |
|------|------|
| `AuthWithQqPlugin.java` | 新增 `saveDefaultWebResources()`，在 `onEnable` 中调用 |
| `InternalWebServer.java` | 修改 `StaticFileHandler`：优先读磁盘文件，再回退到 JAR |

---

## 五、代价评估

| 维度 | 评估 |
|------|------|
| **代码量** | 约 50–80 行（复制逻辑 + 服务逻辑调整） |
| **性能** | 每次请求多一次 `File.exists()`，对 IO 影响极小 |
| **维护** | 新增页面时，若用硬编码列表需同步更新；用 JAR 遍历则无需维护 |
| **兼容性** | 行为兼容，未复制或未自定义时与当前一致 |
| **风险** | 低；路径校验、目录遍历防护需保留 |

---

## 六、更新场景说明

| 场景 | 行为 |
|------|------|
| 首次安装 | 复制默认资源到 `web/` |
| 服主修改 `auth.html` | 使用插件目录中的修改版本 |
| 插件更新新增 `new_page.html` | 插件目录无此文件，自动从 JAR 提供 |
| 插件更新修改 `auth.html` | 已有自定义版本，继续使用，不覆盖 |
| 服主想恢复默认 | 删除 `web/` 或对应文件，下次请求由 JAR 提供 |

---

## 七、建议

- 采用 **方案 A**，实现成本低、风险小、支持自定义且不破坏更新。
- 资源列表优先使用 **JAR 遍历**，减少维护成本；若实现复杂可先用硬编码列表。
